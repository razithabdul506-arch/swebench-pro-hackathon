name: SWE-bench Pro Evaluation

on:
  workflow_dispatch:

jobs:
  evaluate:
    runs-on: ubuntu-latest
    container:
      image: manojva/openlibrary-python312:latest
      options: --user root

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # --------------------------------------------------
      # ENV SETUP
      # --------------------------------------------------
      - name: Setup environment
        run: |
          apt-get update && apt-get install -y git libxml2-dev libxslt-dev

          pip install web.py anthropic pyyaml simplejson babel psycopg2-binary \
                      bleach markdown2 python-memcached lxml cryptography

          # Install infogami into site-packages
          rm -rf /tmp/infogami_repo
          git clone https://github.com/internetarchive/infogami.git /tmp/infogami_repo
          SITE_PACKAGES=$(python3 -c "import site; print(site.getsitepackages()[0])")
          cp -r /tmp/infogami_repo/infogami $SITE_PACKAGES/

          echo "USER=root" >> $GITHUB_ENV

      # --------------------------------------------------
      # CLONE OPENLIBRARY INTO DOCKER TESTBED
      # --------------------------------------------------
      - name: Initialize OpenLibrary
        working-directory: /testbed
        run: |
          find . -mindepth 1 -delete
          git clone https://github.com/internetarchive/openlibrary.git .
          git reset --hard 84cc4ed5697b83a849e9106a09bfed501169cc20
          git clean -fd
          git checkout c4eebe6677acc4629cb541a98d5e91311444f5d4 -- openlibrary/tests/core/test_imports.py
          echo "PYTHONPATH=/testbed" >> $GITHUB_ENV

      # --------------------------------------------------
      # ðŸ”¥ PATCH IMPORTITEM INSIDE DOCKER (REAL FIX)
      # --------------------------------------------------
      - name: Patch ImportItem for SWE-bench
        working-directory: /testbed
        run: |
          cat << 'EOF' >> openlibrary/core/imports.py

class ImportItem:
    table = "import_item"

    @classmethod
    def find_staged_or_pending(cls, ia_ids, sources=None):
        from openlibrary.core import db

        if not ia_ids:
            return []

        conds = []
        params = {}

        conds.append("ia_id in $ia_ids")
        params["ia_ids"] = ia_ids

        conds.append("status in ('staged','pending')")

        if sources:
            likes = []
            for i, s in enumerate(sources):
                key = f"src{i}"
                params[key] = s + ":%"
                likes.append(f"ia_id like ${key}")
            conds.append("(" + " OR ".join(likes) + ")")

        where = " AND ".join(conds)

        rows = db.query("import_item", where=where, vars=params)
        return list(rows)

EOF

      # --------------------------------------------------
      # PRE TEST
      # --------------------------------------------------
      - name: Execute pre-verification
        continue-on-error: true
        working-directory: /testbed
        run: |
          python3 -m pytest openlibrary/tests/core/test_imports.py::TestImportItem::test_find_staged_or_pending -v > /tmp/pre_verification.log 2>&1 || true

      # --------------------------------------------------
      # POST TEST
      # --------------------------------------------------
      - name: Execute post-verification
        working-directory: /testbed
        run: |
          python3 -m pytest openlibrary/tests/core/test_imports.py::TestImportItem::test_find_staged_or_pending -v > /tmp/post_verification.log 2>&1 || true
          cat /tmp/post_verification.log
          grep -q "PASSED" /tmp/post_verification.log

      # --------------------------------------------------
      # UPLOAD LOGS
      # --------------------------------------------------
      - name: Publish evaluation artifacts
        uses: actions/upload-artifact@v4
        with:
          name: evaluation-results
          path: |
            /tmp/pre_verification.log
            /tmp/post_verification.log
