name: SWE-bench Pro Evaluation

on:
  workflow_dispatch:

jobs:
  evaluate:
    runs-on: ubuntu-latest
    container:
      image: manojva/openlibrary-python312:latest
      options: --user root

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup environment
        run: |
          apt-get update && apt-get install -y git libxml2-dev libxslt-dev
          # Complete dependency stack including web.py and system tools
          pip install web.py anthropic pyyaml simplejson babel psycopg2-binary \
                      bleach markdown2 python-memcached lxml cryptography
          echo "USER=root" >> $GITHUB_ENV

      - name: Initialize Repositories
        working-directory: /testbed
        run: |
          # Clean the workspace thoroughly
          find . -mindepth 1 -delete
          
          # Clone OpenLibrary
          git clone https://github.com/internetarchive/openlibrary.git .
          git reset --hard 84cc4ed5697b83a849e9106a09bfed501169cc20
          git clean -fd
          git checkout c4eebe6677acc4629cb541a98d5e91311444f5d4 -- openlibrary/tests/core/test_imports.py

          # Clone Infogami and handle its nested structure
          rm -rf infogami_repo
          git clone https://github.com/internetarchive/infogami.git infogami_repo
          
          # ðŸ”¥ THE CRITICAL FIX: The python package is at infogami_repo/infogami
          # We symlink it to the root so 'import infogami' works perfectly
          ln -s /testbed/infogami_repo/infogami /testbed/infogami
          
          # Install it in editable mode from the package root
          pip install -e /testbed/infogami_repo
          
          # Map PYTHONPATH to the testbed root and the infogami source
          echo "PYTHONPATH=/testbed:/testbed/infogami_repo" >> $GITHUB_ENV

      - name: Execute pre-verification
        continue-on-error: true
        working-directory: /testbed
        run: |
          python -m pytest openlibrary/tests/core/test_imports.py::TestImportItem::test_find_staged_or_pending -v > /tmp/pre_verification.log 2>&1 || true

      - name: Invoke AI Agent
        env:
          CLAUDE_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
        working-directory: /testbed
        run: |
          cp $GITHUB_WORKSPACE/scripts/run_claude.py .
          python run_claude.py --task-file $GITHUB_WORKSPACE/task.yaml

      - name: Generate patch
        working-directory: /testbed
        run: git diff > /tmp/changes.patch

      - name: Execute post-verification
        working-directory: /testbed
        run: |
          python -m pytest openlibrary/tests/core/test_imports.py::TestImportItem::test_find_staged_or_pending -v > /tmp/post_verification.log 2>&1 || true
          echo "--- DEBUG LOG ---"
          cat /tmp/post_verification.log
          grep -q "PASSED" /tmp/post_verification.log

      - name: Compile metrics
        working-directory: /testbed
        run: |
          cp $GITHUB_WORKSPACE/scripts/extract_metrics.py .
          python extract_metrics.py

      - name: Publish evaluation artifacts
        uses: actions/upload-artifact@v4
        with:
          name: evaluation-results
          path: |
            /tmp/agent.log
            /tmp/result.json
            /tmp/pre_verification.log
            /tmp/post_verification.log
            /tmp/changes.patch
            /tmp/prompts.md
